<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Event Management System</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
body{background:#f4f6f9;font-family:'Segoe UI',sans-serif;}
header{background:linear-gradient(45deg,#007bff,#00c6ff);color:white;padding:20px;border-radius:10px;margin-bottom:20px;text-align:center;}
.card{border-radius:15px;transition: transform .2s ease-in-out;}
.card:hover{transform:translateY(-3px);box-shadow:0 4px 20px rgba(0,0,0,.1);}
.nav-tabs .nav-link{font-weight:500;}
.nav-tabs .nav-link.active{background-color:#007bff;color:white !important;border-radius:8px 8px 0 0;}
.btn{border-radius:8px;font-weight:500;}
.table{border-radius:8px;overflow:hidden;}
.table th{background:#007bff;color:white;}
</style>
</head>
<body>
<div class="container py-4">
<header>
<h2>ğŸ“Œ Event Management System</h2>
<p style="margin:0;">Fast Sync Google Sheet Integration</p>
</header>

<ul class="nav nav-tabs justify-content-center" id="myTab" role="tablist">
<li class="nav-item"><button class="nav-link active" data-bs-toggle="tab" data-bs-target="#events">ğŸ“… Manage Events</button></li>
<li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#register">ğŸ“ Register</button></li>
<li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#view">ğŸ‘¥ View Registrations</button></li>
<li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#export">â¬‡ï¸ Export</button></li>
</ul>

<div class="tab-content mt-3">

<!-- Manage Events -->
<div class="tab-pane fade show active" id="events">
<div class="card shadow-sm p-3 mb-4">
<h5>â• Create Event</h5>
<form id="eventForm" class="row g-3">
<div class="col-md-4"><label class="form-label">Event Name</label><input type="text" id="eventName" class="form-control" required></div>
<div class="col-md-4"><label class="form-label">Event Date</label><input type="date" id="eventDate" class="form-control" required></div>
<div class="col-md-4"><label class="form-label">Location</label><input type="text" id="eventLocation" class="form-control" required></div>
<div class="col-12"><button type="submit" class="btn btn-primary w-100">Create Event</button></div>
</form>
</div>
<div class="card shadow-sm p-3">
<h5>ğŸ“‹ Event List</h5>
<div class="table-responsive"><table class="table table-bordered text-center" id="eventTable"><thead><tr><th>Name</th><th>Date</th><th>Location</th><th>Action</th></tr></thead><tbody></tbody></table></div>
</div>
</div>

<!-- Register -->
<div class="tab-pane fade" id="register">
<div class="card shadow-sm p-3">
<h5>ğŸ“ Register for Event</h5>
<form id="regForm" class="row g-3">
<div class="col-md-6"><label class="form-label">Select Event</label><select id="eventSelect" class="form-control" required></select></div>
<div class="col-md-6"><label class="form-label">Naam</label><input type="text" id="name" class="form-control" required></div>
<div class="col-md-6"><label class="form-label">Gender</label><br>
<div class="form-check form-check-inline"><input type="radio" name="gender" value="Male" class="form-check-input" required><label class="form-check-label">Male</label></div>
<div class="form-check form-check-inline"><input type="radio" name="gender" value="Female" class="form-check-input"><label class="form-check-label">Female</label></div></div>
<div class="col-md-6"><label class="form-label">Mobile</label><input type="tel" id="mobile" class="form-control" pattern="[0-9]{10}" required></div>
<div class="col-md-6"><label class="form-label">Email</label><input type="email" id="email" class="form-control" required></div>
<div class="col-md-6"><label class="form-label">DOB</label><input type="date" id="dob" class="form-control" required></div>
<div class="col-md-6"><label class="form-label">Race Name</label><input type="text" id="race" class="form-control" placeholder="Enter Race manually" required></div>
<div class="col-md-6"><label class="form-label">Bib Number</label><input type="number" id="bib" class="form-control" required></div>
<div class="col-12"><button type="submit" class="btn btn-success w-100">Register</button></div>
</form>
</div>
</div>

<!-- View Registrations -->
<div class="tab-pane fade" id="view">
<div class="card shadow-sm p-3">
<h5>ğŸ‘¥ View Event Registrations</h5>
<div class="row mb-3">
<div class="col-md-6"><select id="viewEventSelect" class="form-control"></select></div>
<div class="col-md-6"><button class="btn btn-secondary w-100" onclick="renderRegistrations()">View</button></div>
</div>
<div class="table-responsive"><table class="table table-bordered text-center" id="registrationTable"><thead><tr><th>Name</th><th>Gender</th><th>Mobile</th><th>Email</th><th>DOB</th><th>Race</th><th>Bib</th><th>Action</th></tr></thead><tbody></tbody></table></div>
</div>
</div>

<!-- Export -->
<div class="tab-pane fade" id="export">
<div class="card shadow-sm p-3">
<h5>â¬‡ï¸ Export Registrations to Excel</h5>
<div class="row g-3">
<div class="col-md-6"><select id="exportEventSelect" class="form-control"></select></div>
<div class="col-md-6"><button class="btn btn-warning w-100" onclick="downloadEventExcel()">Export Event</button></div>
<div class="col-12"><button class="btn btn-info w-100 mt-3" onclick="downloadAllExcel()">Export All</button></div>
</div>
</div>
</div>

<script>
const SHEET_URL="https://script.google.com/macros/s/AKfycbwpXwj1sJ0OKAwqg5FAV4Pck3o4VPoAsgYnEGu2qcdOtlR3RFSTD-Z6WSwjI8H7-D_AWg/exec";
let cache={events:[], registrations:[]};

function formatDate(dob){
  let d=new Date(dob);
  return `${String(d.getDate()).padStart(2,'0')}-${String(d.getMonth()+1).padStart(2,'0')}-${d.getFullYear()}`;
}

async function fetchAllData(){
  let res=await fetch(SHEET_URL+"?type=all");
  let data=await res.json();
  cache.events=data.events.map(e=>({name:e[0],date:e[1],location:e[2]}));
  cache.registrations=data.registrations.map(r=>({event:r[0],name:r[1],gender:r[2],mobile:r[3],email:r[4],dob:r[5],race:r[6],bib:r[7]}));
  renderEvents();
  renderRegistrations();
}

function renderEvents(){
  const eventTable=document.querySelector("#eventTable tbody");
  const eventSelect=document.getElementById("eventSelect");
  const viewSelect=document.getElementById("viewEventSelect");
  const exportSelect=document.getElementById("exportEventSelect");
  eventTable.innerHTML=""; eventSelect.innerHTML=""; viewSelect.innerHTML=""; exportSelect.innerHTML="";
  cache.events.forEach(ev=>{
    eventTable.innerHTML+=`<tr><td>${ev.name}</td><td>${ev.date}</td><td>${ev.location}</td>
      <td><button class="btn btn-sm btn-danger" onclick="deleteEvent('${ev.name}')">Delete</button></td></tr>`;
    eventSelect.innerHTML+=`<option value="${ev.name}">${ev.name}</option>`;
    viewSelect.innerHTML+=`<option value="${ev.name}">${ev.name}</option>`;
    exportSelect.innerHTML+=`<option value="${ev.name}">${ev.name}</option>`;
  });
}

function renderRegistrations(){
  let selected=document.getElementById("viewEventSelect")?.value;
  let tbody=document.querySelector("#registrationTable tbody");
  tbody.innerHTML="";
  cache.registrations.filter(r=>!selected||r.event===selected).forEach(r=>{
    let tr=document.createElement("tr");
    tr.innerHTML=`<td>${r.name}</td><td>${r.gender}</td><td>${r.mobile}</td><td>${r.email}</td>
      <td>${formatDate(r.dob)}</td><td>${r.race}</td><td>${r.bib}</td>
      <td><button class="btn btn-sm btn-danger" onclick="deleteRegistration('${r.event}','${r.name}','${r.bib}')">Delete</button></td>`;
    tbody.appendChild(tr);
  });
}

async function deleteEvent(name){
  if(!confirm(`Delete event "${name}" and all registrations?`)) return;
  await fetch(SHEET_URL,{method:"POST",body:JSON.stringify({type:"deleteEvent",name})});
  await fetchAllData();
}

async function deleteRegistration(event,name,bib){
  if(!confirm(`Delete registration of ${name}?`)) return;
  await fetch(SHEET_URL,{method:"POST",body:JSON.stringify({type:"deleteRegistration",event,name,bib})});
  await fetchAllData();
}

document.getElementById("eventForm").addEventListener("submit",async e=>{
  e.preventDefault();
  let ev={type:"event",name:document.getElementById("eventName").value,date:document.getElementById("eventDate").value,location:document.getElementById("eventLocation").value};
  await fetch(SHEET_URL,{method:"POST",body:JSON.stringify(ev)});
  document.getElementById("eventForm").reset();
  await fetchAllData();
});

document.getElementById("regForm").addEventListener("submit",async e=>{
  e.preventDefault();
  let reg={type:"registration",event:document.getElementById("eventSelect").value,name:document.getElementById("name").value,gender:document.querySelector("input[name='gender']:checked").value,mobile:document.getElementById("mobile").value,email:document.getElementById("email").value,dob:document.getElementById("dob").value,race:document.getElementById("race").value,bib:document.getElementById("bib").value};
  await fetch(SHEET_URL,{method:"POST",body:JSON.stringify(reg)});
  document.getElementById("regForm").reset();
  await fetchAllData();
});

function downloadEventExcel(){
  let sel=document.getElementById("exportEventSelect").value;
  let data=cache.registrations.filter(r=>r.event===sel).map(r=>({Name:r.name,Gender:r.gender,Mobile:r.mobile,Email:r.email,DOB:formatDate(r.dob),Race:r.race,Bib:r.bib}));
  if(data.length===0){alert("No registrations for this event"); return;}
  let ws=XLSX.utils.json_to_sheet(data);
  let wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,sel);
  XLSX.writeFile(wb,sel+"_registrations.xlsx");
}

function downloadAllExcel(){
  let data=cache.registrations.map(r=>({Event:r.event,Name:r.name,Gender:r.gender,Mobile:r.mobile,Email:r.email,DOB:formatDate(r.dob),Race:r.race,Bib:r.bib}));
  if(data.length===0){alert("No registrations"); return;}
  let ws=XLSX.utils.json_to_sheet(data);
  let wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"AllRegistrations");
  XLSX.writeFile(wb,"All_Registrations.xlsx");
}

fetchAllData();
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
